<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <title>SanQL Explain Plan Vizualizer</title>
    <link rel="shortcut icon" href="favicon.ico">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script type="text/javascript" src="functions.js"></script>
    <script type="text/javascript" src="walkers.js"></script>
    <script type="text/javascript" src="cookies.js"></script>
<style>
    html {height: 100%;}
    body {font-family: sans-serif;
        background-color: #FAF9FA;
        height: 99%;
        margin-top: 0.5%;
        margin-bottom: 0%;}
    form {margin: 0px}
    #inputs {min-height: 5%}
    #myDiv {height: 94%;
            margin-bottom: 0px;}
    #radios {display: inline-block;}
    fieldset {display: inline-block;}
    textarea {vertical-align: top;}â€‹
    .main-svg {background: #FAF9FA;}
    #myDiv > div > div > svg:nth-child(1) {background-color: #FAF9FA !important;}
</style>
</head>

<body>
    <div id="inputs">
        <form id="data" action="diagram.html" method="get">
            <textarea name="plan" id="planInput" rows="2" cols="80"></textarea>
            <!-- <fieldset id=fields> -->
            <div id=radios>
                <input type="button" name="render" value="Vizualize plan"
                 onclick="vizualizeNew()"><br />
                <input type="radio" id="ff" name="arrangement" value="freeform">
                <label for="ff"> Freeform </label>
                <input type="radio" id="sn" name="arrangement" value="snap">
                <label for="sn"> Snapping </label>
                <input type="radio" id="pp" name="arrangement" value="perpendicular">
                <label for="pp"> Perpendicular </label>
            </div>
            <!-- </fieldset> -->
        </form>
    </div>
    <div id="myDiv"><!-- Plotly chart will be drawn inside this DIV --></div>
</body>

<footer>
    <script>
    var url_string = window.location.href;
    var url = new URL(url_string);
    var plan = url.searchParams.get("plan");
    var arrangement = url.searchParams.get("mode");
    // console.log(plan);
    // alert(JSON.stringify(JSON.parse(plan)))
    var json = JSON.parse(plan)
    String.prototype.format = function () {
        var i = 0, args = arguments;
        return this.replace(/{}/g, function () {
            return typeof args[i] != 'undefined' ? args[i++] : '';
        });
    };

    window.onload = function () {
        arrangement = url.searchParams.get("mode");
        if (!arrangement) {
            var arrangement = getCookie('arrangement_cookie');
            if (arrangement){
                if (arrangement=="freeform") document.getElementById('ff').click();
                else if (arrangement=="snap") document.getElementById('sn').click();
                else if (arrangement=="perpendicular") document.getElementById('pp').click();
            } else {
                document.getElementById('sn').click();  // default
            }
        }
        try {
            document.getElementById("planInput").value = JSON.stringify(json, null, 4)
        } catch (SyntaxError) {
            document.getElementById("planInput").value = plan
        }
        if (arrangement=="freeform") document.getElementById('ff').click();
        else if (arrangement=="snap") document.getElementById('sn').click();
        else if (arrangement=="perpendicular") document.getElementById('pp').click();
    }

    document.getElementById('radios').onclick = function () {
        var ff = document.getElementById('ff');
        var sn = document.getElementById('sn');
        var pp = document.getElementById('pp');
        if (ff.checked) {
            setCookie('arrangement_cookie', ff.value, 30);
        } else if (sn.checked) {
            setCookie('arrangement_cookie', sn.value, 30);
        } else if (pp.checked) {
            setCookie('arrangement_cookie', pp.value, 30);
        }
    }

    function vizualize(json, arrangement="snap") {
        labels = []
        source = []
        target = []
        value = []
        hovers = []
        indexes = {}
        indexes[JSON.stringify(null)] = 0
        labels.push("")
        idx = 1
        try {
            for ([thing, parent, _] of walker(json)) {
                indexes[JSON.stringify(thing)] = idx
                label = ("{}".format(thing["__label"]))
                labels.push(label)
                source.push(idx)
                target.push(indexes[JSON.stringify(parent)])
                // console.log(thing["__cost"]);
                value.push(Math.max(thing["__cost"], 0.00001))  // 0.0 wouldn't plot
                hovers.push(prettify_details(thing))
                // hovers.push(thing)
                // console.log(thing);
                idx += 1
            }
        } catch (e) {
            alert("Unsupported explain plan!")
            throw e
            return
        }
        colors = ["green"]
        for (_ of value) {
            colors.push("blue")
        }

        var data = {
            ids: labels,
            type: "sankey",
            orientation: "h",
            arrangement: arrangement,
            node: {
                pad: 15,
                thickness: 30,
                line: {
                    color: "black",
                    width: 0.5
                },
                label: labels,
                color: colors
            },

            link: {
                source: source,
                target: target,
                value: value,
                label: hovers,
                hoverlabel: {font: {
                    family: "Courier New, monospace"}}
                }
            }

            var data = [data]

            var layout = {
                // title: "Basic Sankey",
                margin: {l: 0, r: 0, t: 0, b: 0},
                font: {
                    size: 12
                }
            }

            Plotly.react('myDiv', data, layout, {showSendToCloud:false})
    }

    vizualize(json, arrangement)

    function vizualizeNew() {
        json = document.getElementById("planInput").value
        try {
            json = JSON.parse(json)
        } catch (SyntaxError) {
            alert("Invalid json!")
            return
        }
        try {
            vizualize(json, selectedMode())
            document.getElementById("planInput").style.height=null
        } catch (Error) {

        }
        plan = encodeURIComponent(JSON.stringify(json))
        window.history.pushState({}, "SanQL", "diagram.html" + "?plan=" + plan + "&mode=" + selectedMode())
    }
    </script>
</footer>
</html>
